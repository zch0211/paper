### 1 绪论

#### 		&nbsp; 1.1 研究背景与研究意义

​	随着科技的不断进步，智能移动设备的不断普及，人们对基于位置的服务(Location Based Service, LBS)提出越来越多的需求并因此衍生出许多优秀的应用，如: 为我们提供基础地图导航的高德地图、腾讯地图；便利我们交通出行的滴滴出行、T3出行等；现在研究火热的无人驾驶也需要基于位置的服务。这些应用大多依托的是卫星定位技术，定位场景处于室外，然而在室内，卫星信号传播易受到大型建筑物的影响，使用卫星定位技术无法实现室内定位，因此我们要研究室内定位技术。研究显示，人每天约有80%的时间处于室内环境中，且室内空间随着人们生活的发展变得越来越大，越来越复杂，室内定位技术愈发凸显其重要性和广阔应用前景。

​	研究室内定位与导航技术的意义有以下几点:

1. 完善城市公共服务

   随着5G和物联网的不断发展，中国的智慧城市建设如火如荼。数据统计显示，截至2017年底，中国超过500个城市均已明确提出或正在建设智慧城市，2022年市场规模已达到25万亿元。大型商超，图书馆，博物馆，会展中心等复杂室内场景都需要成熟的定位导航系统，如大型购物商场，用户也可以查找想要去的店铺和娱乐场所；在环境复杂的地下停车场中，通过室内定位导航帮助消费者轻松停车与寻车。因此研究室内定位与导航技术在建设智慧城市中有着重大意义。

1. 具有可观的商业前景

   室内定位在养老院的应用是一个非常刚需的市场，与老人的安全紧密相关。通过定位技术，实现对老人的实时监护，预防走失。未来几年里养老院会大面积的普及定位系统，用于老人的实时监护，老人的运动轨迹查询，老人在面对危险境遇时，进行紧急呼救。

1. 施工场所人员管理

   在化工厂，地铁施工，隧道施工等施工场所，这些场景下面人员定位都是一个刚需。在这些场景里面一方面出于员工安全的角度，需要对员工进行定位，员工身处危险时进行呼救告警等等。另一方面，在这些场所对访客进行定位管理，防止访客进入一些危险区域。

1. 灾害应急救援

   室内定位对应急救援、消防、安全执法等方面具有重要作用。当发生地震、火灾等紧急事件时，救援的必要条件是快速确定人员位置。特别是当建筑物由于紧急事件布局发生变化时，凭借经验很难快速定位人员位置。在公共场所的恐怖袭击或者突发灾难，用上室内定位技术让后台指挥实时了解现场人员的动向，让现场人员应对更及时有效。室内定位技术可以为救援和国民安全等提供强有力的技术支持，更好地保障救援人员和受困人员的安全。

#### 		&nbsp; 1.2 研究现状

##### 				&nbsp; &nbsp; 1.2.1 室内定位技术

​	现如今存在的室内定位技术主要有Wi-Fi定位、蓝牙定位、声信号定位、行人航迹推算(Pedestrian Dead Reckon, PDR)，计算机视觉定位，超宽带（Ultra Wide Band，UWB）定位。本文主要介绍易于部署且易在移动设备上实现的定位技术，并将所有定位技术通过表格进行技术特点比较。

​	(1) 基于蓝牙的室内定位

​	蓝牙是短称射频信号，低功耗，支持短距离通信，绝大多数智能设备都自带蓝牙模块，易于大范围普及和场地设备的部署，但是基于蓝牙的定位技术容易受到外部噪声信号的干扰，信号稳定性较差，通信范围小。最常用的蓝牙定位技术是基于蓝牙 4.0 的低功耗蓝 牙技术，即 iBeacon 技术，该技术具有低功耗、连接速度更快、传输速率高、信号传输稳定安全无干扰等特点 。iBeacon 技术尚未大规模工程应用，其原因在于需要高密度部署蓝牙信标，加之软件费用较高，使得该系统成本偏高 。

​	(2) 基于Wi-Fi的室内定位

利用 WiFi 信号实现室内定位有 2 种方法，测距交汇法和指纹匹配法。测距交汇法是指利用信号强度衰减模型将 WiFi 信号从接入点到接收机的信号衰减强度转化为 2 者之间距离，采用三角定位法，根据 3 个以上接入点到接收机之间的距离约束对接收机的位置进行估算。该方法优点在于无需建立维护数据指纹库，且定位精度比指纹匹配法精度高；缺点在于信号强度衰减模型与室内环境强相关，由于室内环境复杂多变且非视距现象严重，很难获取准确的信号强度衰减模型。

指纹匹配法是将难以直接测量的位置信息和容易获取的信号特征（如无线信号强度）建立 映射关系，即对应每个室内场景的位置坐标建立专属的信号特征指纹，从而匹配估算出待测目标的空间位置。指纹匹配法分训练和定位 2 步进行： 训练是将定位环境划分网格，并在网格点采集信号指纹，如 WiFi 强度，建立指纹库；定位是将接收到的信号特征测量值与指纹库中的值进行比对，通过相似性分析得到室内位置估计。与测距交汇法相比，该方法的优点在于不需要求解信道衰减模型，缺点在于指纹库的构建需要耗费大量人力。

​	(3) 基于声信号的室内定位

音频定位技术是一种通过测量声波传播时间来计算信号发射端和接收端之间距离的定位技术，其工作模式与全球卫星导航系统(GNSS)定位相同，都是广播模式，具有成本低、精度高、兼容性好等特点，为基于消费级智能手机的室内定位提供了新的可能。音频定位技术可利用智能手机的内置麦克风，在无须改变现有手机的硬件的前提下，实现高精度定位。

但是,相比于无线射频信号,音频信号无法获得很高的更新频率,进而无法获得单位时间内具有统计意义的观测值。因此单次的信号到达时间估计精度,直接影响了定位系统的精度及可用性。由于室内环境复杂,衰减、混响效应严重,直接造成直达经的能量大幅度衰减甚至消失,造成较大的误差。在行人动态定位导航场景中,由人体或物体遮挡引发的“漏检测”,使得到达时间差(time difference of arrival,TDOA)数量无法满足定位最低要求,导致定位失败。此外,分时播发的策略和声速的缘故,使得运动状态下的行人检测到的到达时间时是异步的,同时与声源的相对运动会造成多普勒效应,在到达时间估计中引入一个或正或负的偏差,需要进行补偿。

​	(4) 基于PDR的室内定位

行人航迹推算：随着微机电系统技术的成熟，集成到智能手机平台上的低成本惯性测量单元IMU越来越多，主要常见的是加速度计、陀螺仪和磁力计。由于这些内置运动传感器的成本很低，其稳定性和测量精度也相对较低，不足以用于惯性导航。目前，这些传感器 都用于行人航迹推算，主要是利用加速度计来探测步数、 测量步行速度，再通过磁力计和陀螺仪确定航向， 融合步速和航向推算行人的相对位移量。 整个算法不包含任何积分过程，有效减弱漂移误差的影响。难点在于航向估计。由于室内环境磁干扰相当严重，很难准确估计航向。PDR 是相对定位，航向误差会导致整条航迹的旋转。所以PDR需要跟绝对定位算法融合才能有效抑制系统误差的传播。

##### 	&nbsp; &nbsp; 1.2.2 地图匹配技术

​	地图匹配最初用于室外定位如车辆导航。通过地图数据将行驶的车辆纠正到正确位置，提高定位精度。随着人们对室内定位的不断重视，国内外学者开始将目光投向地图匹配在室内定位中的应用。现有的地图匹配技术概括起来包括基于几何的地图匹配算法、基于拓扑的地图匹配算法和其他高级地图匹配算法三类。

​	(1) 基于几何的地图匹配算法

​		几何匹配算法最初由Bernstein和Kornhauser提出，包括点到点、点到曲线和曲线到曲线。

​	点到点匹配是将真实定位点匹配到地图中距该真实定位点几何距离最近的节点上，但若真实定位点附近正确路径上没有地图中预设的节点，将会将该真实定位点匹配到附近有预设节点的错误路径上。

​	点到曲线匹配是将真实定位点与地图中预设轨迹线段进行距离匹配，找到距其几何距离最近的路段上，但由于没用到历史轨迹，在真实定位点离两条曲线距离较小或相同时容易产生误匹配。

​	曲线到曲线的匹配是多个连续真实定位点构成的定位轨迹被匹配到附近最近的路径上去，相较于前两个，它的精度更高，但需要考虑的因素更多，算法更为复杂。

​	(2) 基于拓扑的地图匹配算法

​	基于几何的地图匹配算法仅考虑了定位点与路径之间的距离信息，这样可能会由于一点小小的误差却出现匹配结果彻底错误的情况。而基于拓扑的地图匹配算法则是在拓
扑地图的基础上，考虑了用户的历史运动，路径连接等信息，更加全面的分析了地图与
用户数据，具有更好的匹配效果。 

​	(3) 其他高级地图匹配算法

使用其他高级概率模型的室内地图匹配技术通常基于递归贝叶斯模型，如隐马尔科夫模型（HMMs）和粒子滤波器（PFs）。其中HMM常用于GPS的地图匹配，需要其和路网之间进行匹配，对于复杂的室内环境，粒子滤波器更为合适。

#### &nbsp; 1.3 本课题的研究内容及章节安排

### 2 融合定位算法和导航模型及地图匹配

#### 2.1 融合定位算法

在第一章中我们介绍到不同的室内定位技术各有其优点和缺点，因此我们考虑多源信息融合定位，将两种或更多定位技术相融合，得到适用性更广，鲁棒性更高的定位方案。在本文中选择使用音频和PDR的融合定位，我们将分为三部分介绍融合定位算法，第一部分是音频定位算法及选择，第二部分是PDR定位，第三部分是多源信息融合定位的滤波框架。

##### 2.1.1 音频定位算法

音频定位算法可分为以下三种：基于到达角(Angle of Arrival, AOA)、基于到达时间(Time of Arrival，TOA)和基于到达时间差(Time Difference of Arrival，TDOA)，本节对这三种算法的原理进行简单介绍并进行对比选择更符合要求的算法。

(1) AOA定位

AOA定位主要包含两个部分：一是发射端发射信号由接收端接收并进行方向角估计；二是根据多个接收端得到的方向角计算发射端(须定位的目标)的位置

在方向角估计中发射端发射寻向信号，而接收端的装置内建麦克风阵列，当信号通过时，根据阵列中的不同阵元接收到声信号的时间，强度和相位不同，进而计算出相对的信号方向角

利用方向角计算目标位置如图所示。其中两个接收端的入射角分别为α1，α2，以接收端为起点，入射角方向构造两直线，两直线的交点，即为发射端的位置。假设发射端的位置坐标为(x,y)，N个接收端的坐标位置为(xi,yi)，根据其几何意义，则它们之间满足
$$
tan\ \alpha_i = \frac{y - y_i}{x - x_i}
$$
将上式展开可得
$$
(x - x_i)tan\ \alpha_i = y - y_i
\\
y_i - x_itan\ \alpha_i = -xtan\ \alpha_i + y
\\
\left[
\begin{array}{1}
y_1-x_1tan\ \alpha_1 \\
y_2-x_2tan\ \alpha_2 \\
...\\
y_n-x_ntan\ \alpha_n \\
\end{array}
\right]
=
\left[
\begin{array}{1}
-tan\ \alpha_1 & 1\\
-tan\ \alpha_2 & 1\\
...\\
-tan\ \alpha_n & 1\\
\end{array}
\right]
\ 
\left[
\begin{array}{1}
x\\
y\\
\end{array}
\right]
\\
Y = AX
$$
根据此式解得发射端位置坐标

<img src="C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230308134211185.png" alt="image-20230308134211185" style="zoom:50%;" />

(2) TOA定位

基于到达时间的定位方法至少需要三个基站(接收端)，才能计算目标的位置。发射端发射信号由接收端接收，根据测量接收信号在发射端和接收端之间的到达时间，然后转换为距离，以接收端为圆心，所测距离为半径做圆，三个圆的交点即为发射端所在位置。该定位方法的优势在于在定位区域内外，都能保持很高的定位精度。但是该方法也存在着弊端，它要求发射端与接收端保持严格的时间同步。

三个基站测得与 MS 的距离分别为r1,r2,r3，以各自基站为圆心测量距离为半径，绘制三个圆，其交点即为 MS 的位置。当三个基站都是 LOS 基站时，一般可以根据最小二乘(LS)算法计算 MS 的估计位置。假设 MS 位的置坐标为(x,y)，N个BS的位置坐标为(xi,yi),它满足以下等式
$$
(x_i - x)^2 + (y - y_i)^2 = r_i^2\ , i = 1,2,···,n
$$

将等式展开化简得到
$$
x_i^2 + y_i^2 + x^2 + y^2 -2xx_i-2yy_i = r_i^2\\
M_i = x_i^2 + y_i^2\ , \ R = x^2 + y^2\\
r_i^2 - M_i = -2xx_i-2yy_i + R\\
\left[
\begin{array}{1}
r_1^2 - M_1 \\
r_2^2 - M_2 \\
...\\
r_n^2 - M_n \\
\end{array}
\right]
=
\left[
\begin{array}{1}
-2x_1\ -2y_1\ 1 \\
-2x_2\ -2y_2\ 1 \\
...\\
-2x_n\ -2y_n\ 1 \\
\end{array}
\right]
\left[
\begin{array}{1}
x \\
y \\
R \\
\end{array}
\right]
\\
Y = AX
$$
要求坐标(x,y)，即求得X。利用最小二乘法可得X。

<img src="C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230320170222745.png" alt="image-20230320170222745" style="zoom:50%;" />



(3) TDOA定位

TDOA定位法的定位过程：预先将所有接收端之间时钟同步，发射端发出信号，不同接收端在不同时刻接收到该信号，选取某参考点接收到信号的时刻作为基准，其他参考点收到的信号的时刻减去该基准得到定位信号到达时间差，该到达时间差即为TDOA值。根据未知点与两个参考点之间的TDOA值可以建立一条双曲线，实现二维定位需要至少三个参考点建立一组双曲线方程求解得到未知点的位置估计，如图所示

![image-20230320194640477](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230320194640477.png)

综上所述，我们在选择定位算法时考虑以下几点：

１．成本问题

在AOA定位算法中的角度估计阶段，用于接收声信号的阵列传感器通常由多个阵元组成，而基于测距原理的两种定位算法，每个节点仅需单个麦克风扬声器设备。相比之下，基于AOA定位原理的定位算法不仅在阵列建设的成本上更加高昂，基于多阵元的角度量测也带来了极大的运算成本，因此AOA定位算法不适用于本文涉及的消费级室内定位场景。

２．时钟同步问题

在消费级室内定位的场景下，尽管定位服务是由用户主动调用的，但目标节点为用户自己的智能设备，定位服务在应用时需要考虑设备的使用权限和兼容性。在TOA和TDOA两种定位算法的测距阶段，TOA的测距需要目标节点和信标节点进行时钟同步，对于没有权限进行时钟同步的设备，就要牺牲定位的实时性换取测距的准确性，而TDOA只需要服务端布置的信标节点进行时钟同步即可，而无需目标节点也进行同步，因此，TDOA定位算法在用户端智能设备上的通用性更强。

３．通用性问题

在消费级室内定位的场景下，还要考虑多目标同时定位的问题。TOA定位和AOA定位都需要信标节点／阵列接收声信号，当对多个目标同时定位时，就会产生多目标数据关联的问题，随着目标的增加计算量和复杂度都会爆炸式增长。

##### 2.1.2 PDR

行人航位推算(PDR)系统是一种受外界因素影响小的定位方法，常见的PDR系统都是利用惯性传感器如加速度传感器、陀螺仪等获得数据并将其与行人行走步态等相关知识结合，推算出行人行走步长及前进方向，进而得到用户的行走轨迹，从而得出用户从初始位置出发行走一段时间后的位置。

但是基于PDR的定位技术的缺点也较为明显：一是智能设备在行人身体的位置和姿势会影响惯性传感器的行人前进方向测量，该误差直接影响定位结果；二是行人行走的步长也受行人身高、外界环境等多方影响；三是受限于MEMS器件的低性能，其航向与步长估计会随着时间增长产生显著的积累误差，使得定位结果偏差大。

因此本文考虑使用基于数据驱动的PDR方法，它是一种基于深度学习的PDR方法，通过该方法从数据集中提取出速度矢量。首先采集不同类别的人行走的惯性传感器数据与行走轨迹将其作为神经网络的输入特征并打上标签，训练出一个拟合行人行走步态特征，适应不同姿态、不同行人的神经网络模型。

该模型以惯性传感器数据作为输入，回归出行人的速度增量，在对速度增量积分得到行人行走轨迹。相较于传统PDR方法，基于数据驱动的PDR不需要对加速度进行两次积分，避免惯性传感器导致的显著误差积累，同时使用该训练模型不再需要对行人行走做出过多约束。

##### 2.1.3 多源信息融合定位的滤波框架

不同单数据源定位方法存在其优势也有不足，因此将不同定位源得到的数据互补能保证更好的定位精度和稳定性。本文使用基于EKF框架的融合定位模型，将PDR数据和TDOA数据融合，得到融合定位结果。

文章设计一个数-模融合的多源融合定位框架，包含数字部分和模型部分。数字部分是一个基于深度学习的神经网络，学习的主要内容是PDR，模型部分是一个耦合PDR神经网络和音频定位的扩展卡尔曼滤波器。

数据驱动部分是指基于大量的传感器数据，通过机器学习技术来建立传感器数据与航迹之间的映射关系，进而推算出行人的位置和姿态。该部分包括两个关键步骤：一是传感器数据的预处理和特征提取，二是基于机器学习算法的航迹推算模型的构建。

首先，为了建立传感器数据与航迹之间的映射关系，需要对传感器数据进行预处理和特征提取。采用了加速度计、陀螺仪和地磁传感器等多种传感器来获取行人的位置和姿态信息，然后通过卡尔曼滤波等算法对传感器数据进行处理和融合，从而提高位置和姿态的准确性。接着，利用自回归移动平均模型（ARMA）对融合后的传感器数据进行特征提取，将其转化为具有一定时序关系的序列数据，用于机器学习算法的输入。

其次，利用机器学习算法构建航迹推算模型，主要采用了长短时记忆网络（LSTM）和支持向量机（SVM）等技术。其中，LSTM作为一种时序数据处理的神经网络模型，能够处理传感器数据中的时序关系，因此被用于航迹推算模型的训练。在模型的构建过程中，通过分析数据集的特征，文章采用了多层的LSTM模型结构，并针对模型的过拟合问题，引入了LSTM的dropout技术。此外，为了提高模型的预测精度，还采用了SVM作为模型的后处理步骤，通过对LSTM模型预测结果的细微调整，提高模型的鲁棒性和稳定性。

本文中的模型驱动定位部分是建立在数据驱动定位的基础上的。在数据驱动定位中，我们得到了每个时间步的步长、方向和地磁信息，并根据这些信息推算出了每个时间步的位置。但是，在实际使用中，这些位置估计结果可能存在较大的误差，尤其是在多路径衍射、信号衰减和磁场干扰等情况下。因此，使用一种基于模型驱动的定位方法，以纠正由于数据驱动定位引入的误差。具体地，采用了EKF滤波器来实现数模融合定位，将惯性传感器和声音传感器的测量结果结合起来，从而提高定位精度。EKF滤波是一种基于卡尔曼滤波的扩展滤波器，它可以用于非线性系统的状态估计，我们将EKF滤波应用于定位中，构建了一个状态空间模型。状态向量包括位置、速度和加速度等状态变量。同时，考虑到方向信息和地磁信息也对定位精度有重要影响，将它们也加入到状态向量中。状态空间模型中还包括了输入向量和观测向量。输入向量包括步长和方向，观测向量包括地磁强度和声音传感器测量结果。这些向量都用来描述系统的动态和状态。

EKF滤波的过程分为预测和更新两个步骤。预测步骤是基于惯性传感器数据进行的。由于惯性传感器在短时间内具有较高的精度，因此该方法利用惯性传感器数据来进行位置预测，以提高定位精度。在预测步骤中，根据上一时刻的状态向量和输入向量，预测当前时刻的状态向量，并计算状态向量的协方差矩阵。在更新步骤中，根据观测向量和预测出的状态向量，计算卡尔曼增益和最优估计值，并更新状态向量和协方差矩阵。

#### 2.2 室内地图模型及地图匹配

室内地图模型是室内定位中必不可少的关键信息，它可以用来校准定位数据。然而，目前还没有一个具体的标准来形式化描述室内地图信息，而且室内环境的多样性意味着室内地图需要经常更新，这增加了地图维护的成本。本章使用一种室内地图信息分类方法，并根据分类结果构建三维室内地图，以减少地图更新的成本。此外，我们还提出了一种基于地图匹配的室内导航模型，它与地图匹配算法相结合，以提高匹配概率。

  **室内地图模型**

​	本文采用一种根据地图中物体的不同特征进行分类的方法，将相同特征的物体分为同一类，还可根据需求将不同类别进行组合以满足用户需求。

​	我们将其分为三个大类，每个大类中包含若干小类。根据物体的可移动性划分出第一大类，它包括三小类，基础类、稳定类和活动类；根据室内地图信息抽象形成第二大类，分别包含区域类，连接类和路径类；根据组成地图的必要信息划分为第三大类，标识类和显示类。地图的信息分类图如下所示：

图2.1

![image-20230418154532235](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230418154532235.png)

下面将详细介绍各类的用途：

1. 基础类要素是地图的基础组件，它包括建筑物的墙壁和固定的物体等，通常不会移动，是整个室内环境的基础。
2. 稳定类要素是地图的稳定组件，主要由大型家具组成，例如桌子、床等，运动比基础类要素略微频繁，但比活动类要素更稳定。
3. 活动类要素是地图的活动组件，主要由小型家具组成，例如带滑轮的工作椅、盆栽等等，因为频繁移动导致地图需要频繁更新。
4. 区域类要素是地图的区域组件，它将室内地图分为可达和不可达区域，包括不同的区域，如房间、走廊、大厅等。
5. 连接类要素是地图的连接组件，用于存储不同区域的可通行连接点，例如房门位置、走廊与大厅的连接区域等。
6. 路径类要素是地图的路径组件，用于表示行人可以行走的路径，并采取将路径看作线段、路口看作节点的拓扑结构来存储。
7. 标识类要素是地图的标识组件，采用文字标记的方式来标识地图信息，例如电梯、楼梯、厕所等。
8. 显示类要素是地图的显示组件，用于在室内定位过程中显示定位结果，可以在新建定位时重新生成该组件。

在介绍完地图信息分类后我们就可以根据其进行地图建模，目前，由于室内定位算法的精度不足，无法提供准确的室内位置数据。然而，室内地图中含有诸如墙壁、窗户、门等室内信息，这些信息能够天然地约束定位点，如防止穿墙等。因此，越来越多的室内定位算法使用室内地图来协助定位，即所谓的地图匹配。地图匹配技术需要室内地图信息来校准定位结果，但室内地图无法直接应用于地图匹配，需要提取地图信息并使用组件表示，以便能够应用于地图匹配。因此，本文提出了一种面向地图匹配的室内地图模型，能够提取墙壁、门和地图标志等信息，并使用组件表示，形成一个可用于地图匹配的拓扑地图模型。

（1）基础组件 
墙壁将室内地图分割成了一些子空间，如房间内，走廊，大厅等空间。若行人想要
从一个空间行走到另一个空间，只能通过连接区域，而不能直接穿过墙壁来达到目的。
所以，墙壁对行人所在的位置具有天然的约束力。在地图中，墙壁属于不可达区域，也
是能够用来判断定位点是否合理的一个有力的依据。 
在本文中，基础组件主要由室内环境的墙壁所构成。当基础组件用来构成室内导航
模型时，为了方便表示，将墙壁抽象为由两点及两点构成的线段的形式来表示，形式化表示为： 
$$
W_{basic}=(V_{basic},E_{basic})
$$
其中$V_{basic}$是基础组件中所有节点的集合，用下标来区分不同节点$V_i$，每个节点含有标识符，坐标等信息，其中$V_{id}$标识此节点ID，$(X_v,Y_v,Z_v)$表示该节点所在位置的三维坐标：
$$
V_i=<V_{id},X_v,Y_v,Z_v>
$$
$E_{basic}$是基础组件中所有的边集，用下标来区分不同边$E_i$，每个边含有唯一标识符$E_{id}$，构成该边的节点$V_i,V_j$，边的长度$L_e$及边的所属区域$A_e$如大厅、过道、房间等，表示为：
$$
E_i=<E_{id},V_i,V_j,L_e,A_e>
$$
（2）稳定组件

在室内我们常常能见到沙发，桌椅等物体，这些不常移动的物体便是稳定组件，稳定组件中的物体一般属于不可达区域，用户不可穿过它，这也是地图匹配的一个约束条件。

为简化模型，我们将这些物体视为规则化物体，用简单的点线表示，因此它的表示方式和基础组件类似。
$$
O_{stable}=(V_{stable},E_{stable})
$$
其中$V_{stable}$是该规则化物体的边缘点，每个点都包含有：
$$
V_i=<V_{id},X_v,Y_v,Z_v>
$$
$E_{stable}$表示该规则化物体的边，每条边都有：
$$
E_i=<E_{id},V_i,V_j,L_e,A_e>
$$
（3）区域组件

区域组件是根据地图中空间的不同功能而划分的区域，同时它也将区域标记为可达区域和不可达区域，行人只能在可达区域中自由行走而不能在不可达区域行走。

我们用$A_e$来表示不同区域，包括大厅、房间、走廊、电梯、扶梯、连接区域：
$$
A_e \in \{Hall,Room,Passgeway,Lift,Stairs,Connect\}
$$
使用$R_e$划分可达和不可达区域
$$
R_e\in\{Reachable,Unreachable\}
$$
（4）连接组件

连接组件中存储地图中的所有连接点。连接点是一个区域到达另一个区域的必经点，只有通过连接点我们才能认为行人是合法移动到另一区域。连接组件可表示为：
$$
D_{connect}=(V_{connect},R_{connect})
$$
其中$V_{connect}$表示地图中所有连接点的集合，每个点$V_i{\in}V_{connect}$有：
$$
V_i=<V_{id},X_v,Y_v,Z_v,A_i,A_j>
$$
其中$<A_i,A_j>$表示该连接点连接的两个不同区域。

$R_{connect}$表示该连接点的半径，每个$R_i{\in}R_{connect}$有：
$$
R_i=<V_i,L_r>
$$
其中$V_i$表示该半径是属于哪个连接点，$L_r$表示半径的长度。

（5）路径组件

路径组件是包含室内地图中所有行人能够行走的路线图，将行人行走的道路分割并抽象为多条线段，两条线段的焦点为一个转向点，形成拓扑室内地图，表示为：
$$
P =(V_{path},E_{path})
$$
其中，$V_{path}$是路径组件中所有节点即两路径相交点的集合，其中对于$V_i{\in}V_{path}$有：
$$
V_i=<V_{path},X_v,Y_v,Z_v>
$$
其中，$V_{path}$代表着当前节点是两条或两条以上路径的交点。若行人当前处于节点的
位置，代表着接下来需要在节点连接的几条路径上选择一条作为行人的下一个匹配路
径。 

$E_{path}$是路径组件中所有路径集合,对于$E_i{\in}E_{path}$都有：
$$
E_i=<E_{path},V_i,V_j,L_e,A_e>
$$


在室内环境下，路径组件通过简单的拓扑图来表示所有可能的行走路径，并将其抽象为不带宽度的线段，以显示道路的中心。当使用地图匹配算法对定位结果进行校准时，将行人的位置修正到路径组件中匹配的路径上。

**地图匹配**

拓扑地图匹配是利用室内地图中的约束信息，如墙壁、走廊等，来校正行人的定位点的方法。一些PDR系统采用地图匹配方法来消除定位误差，例如Li等人提出的PDR方法，该方法利用手机上的PDR（惯性导航）、GPS和蓝牙信号进行定位，并通过粒子滤波算法实现定位融合，通过识别地图中的墙壁或非地板区域来排除不可能的轨迹，然后将用户轨迹与地图上距其最近的路口和路径进行匹配。Guo提出了一种新颖的基于语义匹配的室内轨迹匹配方法。该方法主要利用了轨迹中的语义信息，将轨迹转化为语义特征序列，利用序列匹配算法进行轨迹匹配。该方法通过构建语义地图和语义标记，将室内环境中的区域映射为语义标记，利用语义标记作为轨迹中的语义特征，实现轨迹匹配，同样是利用地图信息来过滤用户不可能到达的位置。

也有文献提出了一种基于传感器测量和运动模型的轨迹估计方法，主要分为两部分，一采用了一个简单的运动模型，假设用户沿着一个固定的方向移动，即在直线段上行走，然后用户会按照一个概率随机地改变方向。这个模型可以被用来预测用户的下一步位置，并将其作为当前位置的估计值；二，由于模型的不确定性，为了提高轨迹的准确性，使用了一种基于点云的匹配算法来匹配当前位置的估计值和真实的位置，然后使用这个匹配结果来校准当前位置的估计值。

综上所述，目前已经有大量对于拓扑的地图匹配方法的研究，但是目前的研究有一些只是将行人运动轨迹与地图路径相比较找到形状相近的作为匹配路径，有一些考虑了定位点与路径之间的关系，但是约束条件过于简单可能会导致连续的匹配误差，最终导致匹配错误。因此，本文提出了一种多重权重的拓扑地图匹配方法，多方面考虑了定位点与路径，路径与路径的关系，并增加了基于历史信息的路径权重作为候选路径的约束；同时将地图匹配方法与前面提出的面向地图匹配的地图导航模型结合起来，增强室内地图对路径选择的约束，从而提高地图匹配的精度。

### 3 拓扑地图匹配方法

在第二章中我们已经介绍多源融合定位以及导航模型，但由于室内环境复杂，信号衰减及反射等原因，室内定位算法的精度还有提升空间，同时由于定位未考虑室内物体，容易将位置定位到物体上导致起始点定位错误或者是连续的两定位点的连线直接穿过物体，若不做处理导致在路线上行人直接穿过物体，考虑到地图中的门，于是我们使用地图信息对定位结果进行修正，即地图匹配。本章使用第二章介绍的地图导航模型作为室内地图信息，并使用若干权重完成地图匹配过程

**3.1 候选路径**
	在进行地图匹配之前，需要以定位点为中心创建一个候选范围，该候选范围可以帮助确认当前定位点可能匹配的路径，从而得到候选路径集合。候选范围的计算公式如下：
$$
R = MAX(\delta,v * t)
$$
公式中的$\delta$表示定位算法的误差值，以米为单位；v代表行人的当前速度，以米每秒为单位；t表示两次定位之间的时间间隔，以秒为单位。该公式的目的是选择定位误差与行人在两次定位之间行走距离中的较大值作为当前定位点的候选范围，这样能够确保行人的真实位置一定包含在候选范围内。 

一旦设置了候选范围，就会考虑所有在候选范围内的路径，所有穿过候选范围和与候选范围相切的路径都将被看作当前定位点的候选路径。然后，将从这些候选路径中找到正确的路径，并将定位点修正到匹配路径中。定位点候选范围与地图拓扑路径如图所示。 

![image-20230422202242656](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422202242656.png)

上图展示了定位误差范围与地图拓扑路径之间的关系。图中的点P1代表当前的定位点，以P1为圆心、R为半径的圆形区域即为定位点的误差范围。L1至L7是地图上的拓扑路径，其中L1、L2、L3和L5穿过误差范围，L6与误差范围相切，因此这些路径被视为当前定位点的候选路径并用蓝色实线标示。L4和L7则使用虚线表示，表示它们不在本次考虑的候选路径范围内。

**3.2 邻近权重**

邻近权重考虑的是定位点与候选路径之间的距离接近程度，用字母D表示。D的值通常是指定位点到候选路径的垂直距离，但由于候选路径是一条线段，有时定位点与候选路径之间没有垂直交点。这种情况下，我们可以计算定位点与候选路径最近端点之间的距离作为D的值。如图所示，虚线为三种不同情况下的距离D。 

![image-20230422203142190](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422203142190.png)

邻近权重随着距离呈线性变化，如公式（3-3）所示：
$$
W_p = P_w / D
$$
​	邻近权重是匹配算法中的一个参数，它通过系数$W_p$来控制。邻近权重的计算基于定位点到候选路径的距离D，当D越小，邻近权重越大，而随着D的增加，邻近权重会逐渐减小。因此，距离定位点更近的路径更有可能成为最终的匹配路径。

**3.3 航向权重**

​	选择下一路径时，航向权重是一个关键参数。其原因在于，若候选路径的方向偏差较大，可能通过行人航向就能确定下一匹配路径；而当候选路径的方向差别不太明显时，航向也会成为一个决定选择下一路径的重要因素。
航向权重通过行人航向与拓扑地图中路径的夹角的余弦值来计算，如公式所示 
$$
W_h=H_wcos(\theta)
$$


​	其中，$W_h$表示航向权重，H_w表示航向权重的系数，$\theta$表示行人航向向量与候选路径方向向量之间的夹角。夹角$\theta$最小为0°，最大为180°。当$\theta$=0°的时候，行人的航向与路径方向是一样的，当$\theta$=180°的时候，说明行人航向与路径方向正好相反。 

​	使用IMU器件，可以精确测量行人的航向。由于室内路径是双向的，因此行人可以选择两个方向行走，所以候选路径的方向不是固定的，每条路径都有两个方向，并随着行人的航向变化而变化。确定所有候选路径的方向需要两个步骤：首先确定行人当前所匹配路径的方向，其方向与行人航向夹角为锐角，因为行人已经匹配在当前路径上，当前路径的方向一定与当前行人航向相近；其次，根据行人在室内的行走规律，其余路径的方向应该是从当前定位点向外发散的方向。因此，航向在确定下一匹配路径时是一个非常重要的参数。如图所示，当前行人航向与路径方向之间的关系。 

![image-20230422202805105](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422202805105.png)

​	在图中，红色圆点P1表示当前的定位点，箭头表示行人当前的朝向。假设路径L1是行人当前匹配的路径，那么L1的方向应与行人当前朝向的夹角为锐角。路径L2~L6位于行人当前航向所指的一侧，因此它们的方向与P1点当前朝向也应该是锐角。另一方面，路径L7和L8与行人当前朝向相反，因此它们的方向应该与行人当前朝向大致相反，也就是夹角为钝角。
​	一旦确定了路径的方向和行人的航向，就可以通过计算它们之间的角度来计算航向权重。根据航向权重的计算公式，当路径方向与行人航向之间的夹角逐渐增大时，航向权重也会逐渐减小。

**3.4 连接权重**

连接权重代表的是候选路径与上一个匹配点所匹配的路径之间是否是相连的，连接
权重的公式如下：
$$
W_c = C_wX
$$


其中，$C_w$为连接权重的系数，X变量随着路径之间是否连接而变化。X={1,−1}。X的取值只有1和−1两种情况。当候选路径与上一个匹配路径之间是相连的时候，X=1；当不相连的时候，X取值−1。 两个路径是否连接要通过第二章所提出的面向地图匹配的地图导航模型路径组件中所定义的拓扑结构来判断。若两个路径有一个相同的节点v，则说明两个路径是相连的。 

**3.5 多权重地图匹配**

本文提出了一种基于多种权重的拓扑地图匹配方法（Topology Map Matching Based 
on Multiple Weights），并将地图匹配方法与第二章所提出的面向地图匹配的地图导航模型结合使用，目的是为了提高地图匹配的准确率，增加室内定位的精度。 

地图匹配可以分为两种情况：一种是在路径上进行匹配，另一种是在连接点处进行匹配。在路径上进行匹配时，匹配结果是行人在当前路径上的位置，而在连接点处进行匹配时，匹配结果是行人所在连接点。地图匹配的流程可以参考下图。

![image-20230422203711334](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422203711334.png)

在进行地图匹配之前，需要先确定当前定位点的误差范围，然后找到所有在误差范围内、与误差范围相交或相切的路径作为候选路径。接下来需要判断行人的移动速度v，如果为0则说明行人没有进行移动，应该将其匹配在上一个匹配路径上。如果行人速度不为0，则说明行人正在朝着航向前进，需要对误差范围中是否包含连接点进行判断。如果包含连接点，则说明行人可能已经到达下一条路径上，需要在连接点处进行地图匹配以找到正确的匹配路径。如果不包含连接点，则行人仍在上一个匹配路径上，需要在路径上进行地图匹配以找到行人当前位置。

**1.初始位置的确定**

​	地图匹配算法的准确性对地图数据和前一次匹配路径具有极大的依赖性。如果前面的匹配误差太大，会导致后面的路径匹配完全错误。因此，为了避免这种情况的发生，需要正确地匹配行人的第一个定位点所在的路径。

​	首先，根据定位点周围的误差范围，建立起初始的候选路径集。因此选择路径的航向和邻近程度成为了寻找正确匹配路径的关键。为此，需要计算每一条候选路径的航向权重和邻近权重，并将两个权重加权得到权重和。最终选择权重更大的路径作为匹配路径。

​	但是如果定位点误差较大，并且路径的权重值相差较小的时候，很可能会匹配了错误的路径

但若定位是产生较大误差，导致正确路径的权重和其他路径的权重相差较近时，可能会匹配到错误路径，如图所示：

![image-20230308141945103](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230308141945103.png)

当定位点在$V_1$时，此时它距离路径$L_1$和$L_2$的距离是相近的，这两条路径的临近权重相差下，当定位点在$V_2$时，行人航向与$L_3$和$L_4$路径的夹角$\alpha$和$\beta$也相近，这两条路径的航向权重也相交，因此，如果行人位置与两条路径的距离相等，或航向角度差不大，那么地图匹配方法误匹配率会增加。为了解决这个问题，本文采用跟踪匹配的方法来验证当前匹配路径是否正确，如果不正确则对结果进行修正。当两条路径与用户航向的夹角之差小于默认角度值30度或两条平行路径之间的距离之差小于默认数值0.5米时，跟踪匹配方法会触发。

跟踪匹配方法的核心思想是在已选定匹配路径的同时，不放弃其他可能路径。不仅对当前匹配路径进行下一步的地图匹配，同时也对其他可能路径继续进行地图匹配，直到定位点与路径之间的距离大于定位算法误差距离或路径方向与用户航向产生了重大偏差。这样可以排除可能的路径，最终确定唯一一条路径作为行人的初始位置。

**2.定位点区域的确定**

​	一旦确定了初始匹配路径，就可以开始后续的地图匹配工作。如果误差范围包含连接点，也就是定位点位于连接点附近，则需要采用连接点处的地图匹配方法。

​	由于室内定位算法可能会有偏差，导致定位点可能出现在不可到达的区域，因此需要先得到当前定位点的候选路径集合，并通过拓扑地图中的信息来排除不可能的路径。

​	无论定位点位于可到达或不可到达区域，都需要找到定位点应该在的正确区域。如果定位点位于可到达区域，需要判断当前定位点所在的区域是否正确，即在当前时刻行人是否有可能到达该区域。如果定位点位于不可到达区域，则需要找到应该将定位点修正回去的区域。定位区域的流程图如图所示：

![image-20230422204057513](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422204057513.png)

首先判断行人当前定位点所在区域Ac是否与上一次匹配点所在区域Ap是同一个区域，若是同一区域，则认为当前行人所在区域与上一次匹配所在区域相同，所以将正确区域设为Ap，删除不属于该区域的路径，并进行后续的地图匹配过程。若不是同一区域，那么需要判断用户上一次匹配位置是否在连接区域，因为如果行人从一个区域到达另一个区域的时候，必定会通过连接区域。若行人经过了连接区域，那么还需要判断当Ac与Ap是不是与该连接点相连。若相连说明定位点区域的变化是正常的，而且上一次匹配没有确定出本次行人具体的位置。所以需要进行连接点处的地图匹配来确定行人当前定位点正确的匹配路径。如果两个区域没有通过连接点相连，那么则需要判断Ap是否和连接点所连接区域A1有公用边，有则将正确区域设置为A1，若没有则需要启用跟踪匹配方法来计算正确匹配路径。若行人没有经过连接区域，这时说明行人不具备到达另一个区域的可能性，所以需要对定位点所在区域进行修正，将不合理的候选路径删除掉，只留下Ac区域的候选路径进行后续的地图匹配过程。

![image-20230422203839828](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422203839828.png)

如图3.9所示，点v1、v2、v3和v4为行人在室内运动时的一系列定位点。初始位置为v1，当定位点为v2的时候，v2所处区域与点v1所处区域相同都为H1区域，因此当处于点v2时，行人正确区域为H1。当定位点为v3的时候，v3与v2同样处在H1区域，且v3还处于连接区域，此时行人的正确区域依然为H1。当定位点为v4时，v4处于R2区域，与v3点所处区域不同，此时需要进行区域校正。尽管上一个点v3处于连接区域，但是该连接区域并没有连接H1与R2两个区域，而是连接了H1与P3两个区域，因此v4的正确区域应该为P3区域。 

**3.基于多权重的地图匹配**

​	当确定了定位点所在区域之后，就需要对候选路径的权重值进行计算，并选择出当前定位点匹配的路径，以及在路径上具体的位置。 

​	地图匹配分为在连接区域的地图匹配和在路径上的地图匹配两种情况。

 	当行人当前处于连接区域的时候，采用连接区域的地图匹配方法。由于在连接区域行人将会有很多条不同的路径可以选择，所以在进行路径选择的时候需要根据每一条候选路径的总权重来正确的选择路径。并且由于在连接点处的候选路径的总权重可能会比较相近，所以在选择匹配路径后，也可能使用跟踪匹配方法来对所选择的路径进行跟踪确认。 
 	当行人的前进速度为0时，说明行人的位置没有变化，所以选择上一次的匹配路径作为本次的匹配路径。 
 	当行人当前定位点的误差范围中不包含连接点的时候，说明行人目前不需要进行路径选择，所以选择上一次的匹配路径作为本次的匹配路径。

​	确定了当前定位点所匹配的路径后，还需要将定位点映射到路径上面。在确定行人当前在路径上的匹配位置的时候，不再简单的使用定位点垂直投影到匹配的方法得到行人当前在路径上的匹配位置，而是采用了行人行走路程和匹配投影结合的方法来确定行人在路径上的匹配点。 
​	首先需要确认行人在本次定位间隔中的行进路程S。由于行人在行走过程中不一定会匀速前进，所以需要计算行人的加速度。加速度由上次匹配点与本次定位点的速度向量所在匹配路径方向的分量相减得到，如图所示： 

![image-20230422204356123](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422204356123.png)

​	加速度a为$v_{1m}-v_{2m}$，所以，在本次定位间隔中行人行走的路径S使用公式计算：
$$
S=V_{1m}+1/2at^2
$$


​	设垂直投影到匹配路径的点与上一次匹配点之间的距离为S’，计算S与S’两个路径的平均值作为用户在本次定位间隔中的行进路程，并将定位点修正到匹配路径上的相应位置。 
​	确定好匹配点后，对于该定位点的地图匹配过程就结束了。行人在行走的过程中，每一次定位都会进行一次地图匹配来修正定位点，来增加定位的精度。 

### 4 实验结果与分析

​	为了验证本文提出的基于多重权重的拓扑地图匹配算法的可行性与有效性，本文使
用MATLAB室内场景与定位系统，并对地图匹配算法进行仿真，对其准确性进行测试，
并与未使用拓扑地图算法进行对比。 

**4.1 仿真场景设置**

本实验采用实验室作为实验场景，如图所示：

![image-20230422210709673](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422210709673.png)

![image-20230422212831863](C:\Users\Work\AppData\Roaming\Typora\typora-user-images\image-20230422212831863.png)

### 5 总结与展望

#### 		&nbsp; 5.1 研究工作总结

#### 		&nbsp; 5.2 下一步工作展望

